!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","underscore","jquery","exports"],function(c,d,e,f){a.Frame=b(a,f,c,d,e)});else if("undefined"!=typeof exports){var c=require("backbone"),d=require("underscore");b(a,exports,c,d)}else a.Frame=b(a,{},a.Backbone,a._,a.jQuery||a.Zepto||a.ender||a.$)}(this,function(a,b,c,d,e){function f(){}function g(a,b,c){return d.isEmpty(c)?a:a.replace(b,function(a){return c[a]})}b.TEMPLATES={},b._store={};var h=(b.App=c.Model.extend({defaults:{followLinks:!0,routes:{}},initialize:function(a){a&&this.set(a),a.templates&&(b.TEMPLATES=a.templates),this.get("followLinks")&&(this._linkHelper=new b.LinkHelper),this._dispatcher=new b.Dispatcher({routes:this.get("routes")}),b._app=this,d.defer(function(){c.history.start({pushState:!0})})}}),b.mediator=d.extend({},c.Events)),i=b.mixin=function(){var a=Array.prototype.slice.apply(arguments);return d.each(a,function(a){d.isString(a)&&(a=require("mixins/"+a)),this.prototype.events&&a.events&&d.merge(this.prototype.events,a.events),this.prototype.initialize&&(this.prototype.initialize=d.wrap(this.prototype.initialize,function(b){var c=Array.prototype.slice.call(arguments,1);a.init&&a.init.apply(this,c),b.apply(this,c),a.afterInit&&a.afterInit.apply(this,c)})),d.merge(this.prototype,a.props)},this),this},j=b.LinkHelper=function(){this.mediator=h,e(document).on("click","a",this.onClick.bind(this))};j.prototype.onClick=function(a){var b,c=e(a.currentTarget),f=c.attr("href"),g=c.data();f&&"#"!==f&&"javascript:;"!==f&&!a.metaKey&&(b=d.extend({trigger:!0},g),b.external||(a.preventDefault(),this.mediator.trigger("navigate",f,b)))};var k=b.modelFactory=function(a,b,c){var d,e;if(!a)throw"Model type is required!";if(d="models/"+a,e=require(d),!e)throw d+" is an undefined model";return new e(b,c)},l=b.collectionFactory=function(a,b,c){var e,f;if(!a||!d.isString(a))throw"Collection type is required!";if(e="collections/"+a,f=require(e),!f)throw e+" is an undefined collection";return new f(b,c)},m=b.store={get:function(a){var c,e=a.resource+":";if(a.options||(a.options={}),e+=d.isFunction(a.id)?a.id(a.data,a.options):a.id,c=b._store[e],c&&c._TTL<=Date.now()&&(c=null,this.destroy(e)),!c){try{c=k(a.resource,a.data,a.options)}catch(f){try{c=l(a.resource,null,a.options)}catch(f){throw new Error("Resource ("+a.resource+") was not found as either model or collection")}}this.set(e,c)}return c},set:function(a,c,d){b._store[a]=c,d&&(d===!0&&(d=3e5),c._TTL=Date.now()+d)},destroy:function(a){var c=b._store[a];return delete b._store[a],c}},n=b.fetcher={fetch:function(a){var b,c;return a.options&&(c=a.options.ajax,delete a.options.ajax),b=m.get(a),b.fetchCached(c),b}},o=/(\(\?)?:\w+/g,p=b.Model=c.Model.extend({mediator:h,initialize:function(a,b){return b||(b={}),this._nested=b.nested,this.associated||(this.associated={}),this.expandFields=b.expandFields||this.expandFields,this.urlRoot&&(this._resourceUrl=this.urlRoot,this.urlRoot=this._urlRoot),this.setFetched(!!b.fetched),this.init.apply(this,arguments),this},init:function(){},_urlRoot:function(){var a=d.result(this,"_resourceUrl"),b=0;if(!a)throw"url is required to fetch resource";return this._nested&&this._nested.length&&(a=a.replace(o,function(a){return a=this._nested[b],b+=1,a}.bind(this))),a},_watchNested:function(a,b){var c=d.bind(this._updateNested,this,a,b);this.listenTo(b,"change",c),this.listenTo(b,"add",c),this.listenTo(b,"remove",c)},_updateNested:function(a,b){this.set(a,b.toJSON())},parse:function(a){var b,c,e,f;return this.expandFields&&(this.associated={},d.each(this.expandFields,function(d){d=d.split(">"),e=d[0],f=a[e],f&&(1==d.length&&(d.push(f.length?"collections":"models"),d.push("base")),b=require(d[1]+"/"+d[2]),c=new b(f),this._watchNested(e,c),this.associated[e]=c)},this)),a},store:function(a){m.set(a,this)},reset:function(a,b){a||(a={}),this.clear(b),this.set(a,b)},collectionAt:function(){return this.collection.indexOf(this)},isFetched:function(){return this._fetched},setFetched:function(a){this._fetched=a,a&&(this.promise=e.Deferred().resolve(this))},fetch:function(){return this.promise=c.Model.prototype.fetch.apply(this,arguments).then(function(){return this.trigger("fetched"),this.setFetched(!0),this}.bind(this)),this.trigger("fetch",this.promise),this.promise},fetchCached:function(a){return this.isFetched()?e.Deferred().resolve(this):this.promise&&"pending"===this.promise.state()?this.promise:this.fetch(a)},when:function(a,b){var c=e.Deferred(),f=this.get(a);return(b&&f===b||d.isUndefined(b)&&f)&&c.resolve.call(this,this,f),this.on("change:"+a,function(a,e){(d.isUndefined(b)&&e||e===b)&&c.resolve.apply(this,arguments)}),c},save:function(){this.trigger("save");var a=this.promise=c.Model.prototype.save.apply(this,arguments);return a?a.then(function(){this.collection&&"base"!=this.collection.modelName&&this.store(this.collection.modelName+":"+this.id),this.setFetched(!0),this.trigger("save:success")}.bind(this)).fail(function(a){this.trigger("save:failed",a)}.bind(this)):this.trigger("save:invalid"),a}});p.mixin=i;var q=b.Collection=c.Collection.extend({mediator:h,model:p,modelName:"base",initialize:function(a,b){b||(b={}),this.setFetched(!!b.fetched),this._nested=b.nested,this._resourceUrl=this.url,this.url=this._url,this.allowEmpty=this.allowEmpty,this.init.apply(this,arguments)},init:function(){},_url:function(){var a=d.result(this,"_resourceUrl"),b=0;if(!a)throw"url is required to fetch resource";return a=a.replace(o,function(a){return a=this._nested[b],b+=1,a}.bind(this))},_prepareModel:function(a,b){if(a instanceof c.Model)return a;b=b?d.clone(b):{},b.collection=this;var e=this._model(a,b);return e.validationError?(this.trigger("invalid",this,e.validationError,b),!1):e},_model:function(a,c){var e;return this.model?(e=new this.model(a,c),e.id&&"base"!=this.modelName&&e.store(this.modelName+":"+e.id)):e=new b.Model(a,c),d.keys(a).length>1&&e.setFetched(!0),e},move:function(a,b){var c=this.indexOf(a);if(-1==c)throw new Error("Can't move a model that's not in the collection");c!==b&&this.models.splice(b,0,this.models.splice(c,1)[0]),this.trigger("move",a,c,b)},store:function(a){m.set(a,this)},isFetched:function(){return this._fetched},setFetched:function(a){this._fetched=a,a&&(this.promise=e.Deferred().resolve(this))},fetch:function(){return this.promise=c.Collection.prototype.fetch.apply(this,arguments).then(function(){return(this.length||this.allowEmpty)&&this.setFetched(!0),this.trigger("fetched"),this}.bind(this)),this.trigger("fetch",this.promise),this.promise},fetchCached:function(a){return this.isFetched()?e.Deferred().resolve(this):this.promise&&"pending"===this.promise.state()?this.promise:this.fetch(a)}});q.mixin=i;var r=["bodyClass","el"],s=b.Controller=function(a){this.cid=d.uniqueId("controller"),this._configure(a||{}),this.views=[],this._actionResources={},d.each(this.resources,function(a,b){a===!0&&(a={});var c=a.actions;a.name=b,c&&"all"!==c[0]||(c=d.keys(this.actions)),d.each(c,function(b){var c;d.isArray(this._actionResources[b])||(this._actionResources[b]=[]),c=this._actionResources[b],c.push(a)},this)},this),this.$el=e(this.el?this.el:"<div/>"),this.initialize.apply(this,arguments)};d.extend(s.prototype,c.Events,{mediator:h,fetcher:n,store:m,initialize:function(){},_configure:function(a){this.options&&(a=d.extend({},d.result(this,"options"),a)),d.extend(this,d.pick(a,r)),this.options=a},_action:function(a){var b,c=d.compact(Array.prototype.slice.call(arguments,1)),f=this.actions[a],h=[];if(!d.isFunction(f))throw"Controller does not support the "+a+" action!";if(e("html, body").scrollTop(0),this.setBodyClass(this.bodyClass),b=this._actionResources[a],d.isArray(b)&&b.length){var i,j,k,l,m={},n={},o=1;d.each(c,function(a){n["$"+o]=a,o+=1}),c.length&&(l=c[c.length-1]),d.each(b,function(a){k=a.resource||a.name.replace(/([A-Z])/g,function(a){return"_"+a.toLowerCase()}),j=d.uniqueId(k),i=null,a.id&&(j=d.isFunction(a.id)?a.id.apply(this,c):g(a.id,/\$\d+/g,n)),a.params&&(i={},d.each(a.params,function(a,b){a=g(a,/\$\d+/g,n),i[b]=a}));var b=this.fetcher.fetch({id:j,resource:k,data:l?{id:l}:null,options:{nested:c,ajax:i?{data:i}:null}});a.wait&&h.push(b.promise),m[a.name]=b},this),h.length&&this.onLoading.call(this,h),e.when.apply(e,h).always(function(){this.$el.empty()}.bind(this)).then(function(){f.call(this,m,c)}.bind(this),function(){this.onError.apply(this,arguments)}.bind(this))}else f.apply(this,c)},append:function(a){return d.isArray(a)||(a=[a]),d.each(a,function(a){this.views.push(a),this.$el.append(a.render().$el),a._onInsert()},this),this},setBodyClass:function(a){e("body").removeClass(this.bodyClass),e("body").removeClass(this.actionBodyClass),this.actionBodyClass=a,this.actionBodyClass&&e("body").addClass(this.actionBodyClass)},setPageTitle:function(a){e("title").text(a)},remove:function(){e("body").removeClass(this.bodyClass),e("body").removeClass(this.actionBodyClass),d.invoke(this.views,"remove"),this.$el.empty(),this.views=[]},onLoading:function(){},onError:function(){}}),s.extend=c.Model.extend,s.mixin=i;var t=["routes","controllerPath","middlewarePath"],u=b.Dispatcher=function(a){this.cid=d.uniqueId("dispatcher"),this._configure(a||{}),this._router=new c.Router,this.buildRoutes(this.routes),this.initialize.apply(this,arguments)};d.extend(u.prototype,c.Events,{nestCount:0,controllerPath:"controllers/",middlewarePath:"middlewares/",mediator:h,initialize:function(){this.mediator.on("navigate",this._router.navigate,this),this.on("dispatched",function(){this.mediator.trigger("dispatched")},this)},_configure:function(a){this.options&&(a=d.extend({},d.result(this,"options"),a)),d.extend(this,d.pick(a,t)),this.options=a},loadMiddlewares:function(a){return d.map(a,function(a){return require(this.middlewarePath+a)},this)},buildRoutes:function(a,b,c){var e;b||(b=""),this.nestCount+=1,d.each(a,function(a,f){c||(c=[]),"middleware"===f?(d.isArray(a)||(a=[a]),c=c.concat(this.loadMiddlewares(a))):d.isObject(a)?(1===this.nestCount?b=f:b+=f,this.buildRoutes(a,b,c),this.nestCount-=1):(e=f,b&&(e=b+e),this._router.route(e,d.bind(this.dispatch,this,a,c)))},this)},dispatch:function(a,b){var c=Array.prototype.slice.call(arguments,2),e=a.split("#"),f=e[0],g=e[1],h=require(this.controllerPath+f),i="";if(b&&b.length&&d.each(b,function(a){a.apply(null,c)}),!h)throw f+" is not a defined controller";if(c.unshift(g),this._activeController&&this._activeController.remove(),this._activeController&&this._activeControllerName===f||(this._activeController=new h(c)),i=this._activeController.actions[g],!i)throw f+" controller has not implemented "+g;this._activeController._action.apply(this._activeController,c),this._activeControllerName=f,this.trigger("dispatched",f,g)}}),u.extend=c.Model.extend;var v=["template","skipDependencies"],w=b.View=c.View.extend({waitForResources:!0,init:f,afterRender:f,onRemove:f,onError:f,showLoader:f,hideLoader:f,mediator:h,initialize:function(a){a||(a={}),this._rendered=!1,this._views=[],this._errors=[],this.resources=d.extend({},a.resources),d.extend(this,d.pick(a,v)),this.data=d.extend({},this.data),a.data&&this.set(a.data),this.template&&this.set("template",this.template),this.mediatorEvents&&this._attachMediatorEvents(),this.resourceEvents&&this._attachResourceEventsGroup(this.resourceEvents),this.$el.on("remove",d.bind(this.remove,this));var b;this.waitForResources&&(b=this.collectResourcesPromises(),b.length&&this.whenFetching(b)),this.init(a)},render:function(){var a={},b={};return this.fetching?this:(this._template&&(d.each(this.resources,function(b,c){b&&(a[c]=b.models?d.pluck(b.models,"attributes"):b.attributes)}),this.model&&(a.model=this.model.attributes),d.each(d.result(this,"data"),function(a,c){b[c]=this.get(c)},this),d.extend(a,b),this.$el.html(this._template(a))),this._rendered=!0,this.afterRender(this.resources),this)},get:function(a){return a=this.data[a],d.isFunction(a)?a.call(this):a},set:function(a,c){return"template"===a?void(this._template=b.TEMPLATES[c]):(void 0===c?d.merge(this.data,a):this.data[a]=c,void(this._rendered&&this.render()))},prepend:function(a,b){return d.isString(b)&&(b=this.$(b)),this._attach("prepend",a,b),this},prependTo:function(a){return this.prepend(this,a),this},append:function(a,b){return d.isString(b)&&(b=this.$(b)),this._attach("append",a,b),this},appendTo:function(a){return this.append(this,a),this},after:function(a,b){return d.isString(a)&&(a=this.$(a)),this._attach("after",b,a),this},before:function(a,b){return d.isString(a)&&(a=this.$(a)),this._attach("before",b,a),this},empty:function(){return this._removeNested(),this.$el.html(""),this},reset:function(a){d.isUndefined(a)&&(a=[]);var b=this._renderViews(a);return this.$el.html(b),this._removeNested(),this._viewsInserted(a),this},replaceWith:function(a){this.$el.after(a.render().el),a.delegateEvents(),a._onInsert(),this.remove(),this.listenTo(a,"all",this.trigger)},remove:function(){return this.hasRemoved||(this.hasRemoved=!0,this._removeMediatorEvents(),this._removeNested(),c.View.prototype.remove.call(this),this.$el.off("remove"),this.onRemove()),this},getItemById:function(a){var b,c,d=a.attr("data-id");return b=this.collection.get(d?d:a.closest("[data-id]").attr("data-id")),b||(c=a.attr("data-cid"),b=this.collection.get(c?c:a.closest("[data-cid]").attr("data-cid"))),b},stopProp:function(a){return a&&a.stopPropagation&&(a.stopPropagation(),a.preventDefault()),this},stopPropagation:function(a){return a&&a.stopPropagation&&a.stopPropagation(),this},collectResourcesPromises:function(){function a(a){a&&a.promise&&"pending"===a.promise.state()&&b.push(a.promise)}var b=[];return d.each(this.resources,a),this.model&&a(this.model),this.collection&&a(this.collection),b},whenFetching:function(a){this.fetching||(!d.isArray(a)&&(a=[a]),this.fetching=!0,this.showLoader(a),e.when.apply(e,a).always(function(){this.fetching=!1,this.hideLoader()}.bind(this)).then(this.afterFetch.bind(this),this.onError.bind(this)))},afterFetch:function(){this.render()},_onInsert:function(){this.hasRemoved=!1,this.onInsert&&d.defer(this.onInsert.bind(this))},_renderViews:function(a){return d.map(a,function(a){return a.render().el},this)},_viewsInserted:function(a){d.each(a,function(a){a!=this&&this._views.push(a),a._onInsert.call(a)},this)},_removeNested:function(){d.invoke(this._views,"remove"),this._views=[]},_attach:function(a,b,c){c||(c=this.$el),d.isArray(b)||(b=[b]);var e=this._renderViews(b);c[a](e),this._viewsInserted(b)},_attachMediatorEvents:function(a){(a||(a=d.result(this,"mediatorEvents")))&&(this._removeMediatorEvents(),d.each(a,function(a,b){if(d.isFunction(a)||(a=this[a]),!a)throw new Error("Method "+a+" does not exist");this.mediator.on(b,a,this)},this))},_removeMediatorEvents:function(){this.mediator.off(null,null,this)},_attachResourceEventsGroup:function(a){var b,c,e=this.resources;d.each(a,function(a,d){if(c=d.split("."),("collection"==c[0]||"model"==c[0])&&(e=this),b=c.reduce(function(a,b){return a[b]},e),!b)throw new Error(d+" not found in view to attach events to");this._attachResourceEvents(a,b)},this)},_attachResourceEvents:function(a,b){d.each(a,function(a,c){d.each(a.split(" "),function(a){if(d.isFunction(a)||(a=this[a]),!a)throw new Error("Method "+a+" does not exist");this.listenTo(b,c,a)},this)},this)}});w.mixin=i;{var x=["modelView","infinite","$infiniteTarget"];b.CollectionView=w.extend({showEmpty:f,hideEmpty:f,collectionEvents:{reset:"render",add:"addOne hideEmpty",remove:"checkEmpty",fetch:"whenFetching"},initialize:function(a){w.prototype.initialize.apply(this,arguments),d.bindAll(this,"onScroll"),d.extend(this,d.pick(a,x)),this._setupInfinite(a),this._attachResourceEventsGroup({collection:this.collectionEvents})},render:function(){var a=this._template?this._template():"";return this.hideEmpty(),this.$el.html(a),this.fetching?this:(this.collection.length?this.collection.each(this.addOne,this):this.showEmpty(),this.afterRender(),this)},addOne:function(a){var b,c,d=this.collection.indexOf(a);return c=new this.modelView({model:a,resources:this.resources}),this.beforeEach&&c.$el.before(this.beforeEach(a)),b=this._viewElAt(d),b.length?this.before(b,c):this.append(c),this.afterEach&&c.$el.after(this.afterEach(a)),this._views.push(c),c},onScroll:function(){var a=this.$infiniteTarget.scrollTop()+this.$infiniteTarget.height(),b=this.$infiniteTarget.get(0).scrollHeight||e(document).height();if(a>=b-this.infniteOptions.offset&&!this.fetching&&this.prevScrollY<=a&&!this.infiniteEnd){var c=this.collection.length,f={remove:!1};if(!c&&this.collection.isFetched())return void(this.infiniteEnd=!0);this.infniteOptions.data&&(f.data=d.result(this.infniteOptions,"data")),this.collection.fetchNext(f).always(function(){this.collection.length===c&&(this.infiniteEnd=!0)}.bind(this))}this.prevScrollY=a},afterFetch:function(){this.checkEmpty()},checkEmpty:function(){0===this.collection.length?this.showEmpty():this.hideEmpty()},onRemove:function(){this.$infiniteTarget&&this.$infiniteTarget.off("scroll",this.onScroll)},_setupInfinite:function(){this.infinite&&(this.infniteOptions=d.extend({offset:300},this.infinite),this.$infiniteTarget=this.$infiniteTarget||this.$el,this.$infiniteTarget.on("scroll",this.onScroll))},_currentRenderedCount:function(){var a=this.modelView.prototype.className.split(" ")[0];return this.$("."+a).length},_viewElAt:function(a){var b=this.modelView.prototype.className.split(" ")[0];return this.$("."+b).eq(a)}}),b.ItemView=w.extend({modelEvents:{change:"render",invalid:"onInvalid",remove:"removeItem"},initialize:function(){this.model&&this._attachResourceEvents(this.modelEvents,this.model),this.collection=this.model.collection,w.prototype.initialize.apply(this,arguments)},removeItem:function(a,b,c){c&&c.silent||this.remove()},onInvalid:f})}return b});