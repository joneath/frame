!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","underscore","jquery","exports"],function(c,d,e,f){a.Frame=b(a,f,c,d,e)});else if("undefined"!=typeof exports){var c=require("underscore"),d=require("backbone");b(a,exports,d,c)}else a.Frame=b(a,{},a.Backbone,a._,a.jQuery||a.Zepto||a.ender||a.$)}(this,function(a,b,c,d,e){function f(a,b,c){return d.isEmpty(c)?a:a.replace(b,function(a){return c[a]})}function g(){}var h=/(\(\?)?:\w+/g;b.App=c.Model.extend({defaults:{modelPath:"models/",collectionsPath:"collections/",controllerPath:"controllers/",middlewarePath:"middlewares/",mixinPath:"mixins/",followLinks:!0,routes:{}},initialize:function(a){a&&this.set(a),this.get("followLinks")&&(this._linkHelper=new b.LinkHelper),this._dispatcher=new b.Dispatcher({routes:this.get("routes"),controllerPath:this.get("controllerPath"),middlewarePath:this.get("middlewarePath")}),e(function(){c.history.start({pushState:!0})}),b._app=this}});var i=b.mediator=d.extend({},c.Events),j=b.mixin=function(){var a=Array.prototype.slice.apply(arguments);return d.each(a,function(a){d.isString(a)&&(a=require(b._app.get("mixinPath")+a)),this.prototype.events&&a.events&&d.merge(this.prototype.events,a.events),this.prototype.initialize&&(this.prototype.initialize=d.wrap(this.prototype.initialize,function(b){var c=Array.prototype.slice.call(arguments,1);a.init&&a.init.apply(this,c),b.apply(this,c),a.afterInit&&a.afterInit.apply(this,c)})),d.merge(this.prototype,a.props)},this),this},k=b.LinkHelper=function(){this.mediator=i,e(document).on("click","a",this.onClick.bind(this))};k.prototype.onClick=function(a){var b,c=e(a.currentTarget),f=c.attr("href"),g=c.data();f&&"#"!==f&&"javascript:;"!==f&&!a.metaKey&&(b=d.extend({trigger:!0},g),b.external||(a.preventDefault(),this.mediator.trigger("navigate",f,b)))};var l=b.modelFactory=function(a,c,d){var e,f;if(!a)throw"Model type is required!";if(e=b._app.get("modelPath")+a,f=require(e),!f)throw e+" is an undefined model";return new f(c,d)},m=b._appModels={},n=b.modelManager={get:function(a,b,c,e){var f,g=a+":";return g+=d.isFunction(b)?b(c,e):b,f=m[g],f&&f._TTL<=Date.now()&&(f=null),f||(f=l(a,c,e),this.set(g,f)),f},set:function(a,b){m[a]=b,b._TTL=Date.now()+(b.cacheTTL||3e5),b.on("change",this._updateTTL)},destroy:function(a){var b=m[a];b.off("change",this._updateTTL),delete m[a]},_updateTTL:function(){this._TTL=Date.now()+(this.cacheTTL||3e5)}},o=b.collectionFactory=function(a,c,e){var f,g;if(!a||!d.isString(a))throw"Collection type is required!";if(f=b._app.get("collectionPath")+a,g=require(f),!g)throw f+" is an undefined collection";return new g(c,e)},p=b._appCollections={},q=b.collectionManager={get:function(a,b,c,d){var e=a+":"+b,f=p[e];return f&&f._TTL<=Date.now()&&(f=null),f||(f=o(a,c,d),this.set(e,f)),f},set:function(a,b){p[a]=b,b._TTL=Date.now()+(b.cacheTTL||3e5),b.on("change",this._updateTTL)},destroy:function(a){var b=p[a];b.off("change",this._updateTTL),delete p[a]},_updateTTL:function(){this._TTL=Date.now()+(this.cacheTTL||3e5)}},r=b.fetcher={fetch:function(a){var b;return b=a.model?n.get(a.model,a.id,a.data,a.options):q.get(a.collection,a.id,a.data,a.options),b.fetchCached(a.fetchOptions),b}},s=b.Model=c.Model.extend({mediator:i,initialize:function(a,b){var c,e,f,g;return b||(b={}),this.associated=d.extend({},b.associated),this.expandFields=b.expandFields||this.expandFields,this.setFetched(!!b.fetched),this.expandFields&&d.each(this.expandFields,function(a){a=a.split(">"),f=a[0],g=this.get(f),1==a.length&&(a.push(g.length?"collections":"models"),a.push("base")),c=require(a[1]+"/"+a[2]),e=new c(g),this._watchNested(f,e),this.associated[f]=e},this),this.init.apply(this,arguments),this},init:function(){},_watchNested:function(a,b){var c=d.bind(this._updateNested,this,a,b);this.listenTo(b,"change",c),this.listenTo(b,"add",c),this.listenTo(b,"remove",c)},_updateNested:function(a,b){this.set(a,b.toJSON())},store:function(a){n.set(a,this)},reset:function(a,b){a||(a={}),this.clear(b),this.set(a,b)},collectionAt:function(){return this.collection.indexOf(this)},isFetched:function(){return this._fetched},setFetched:function(a){this._fetched=a,a&&(this.promise=e.Deferred().resolve(this))},fetch:function(){return this.promise=c.Model.prototype.fetch.apply(this,arguments).then(function(){this.trigger("fetched"),this.setFetched(!0)}),this.trigger("fetch",this.promise),this.promise},fetchCached:function(a){return this.isFetched()?e.Deferred().resolve(this):this.promise&&"pending"===this.promise.state()?this.promise:this.fetch(a)},when:function(a,b){var c=e.Deferred(),f=this.get(a);return(b&&f===b||d.isUndefined(b)&&f)&&c.resolve.call(this,this,f),this.on("change:"+a,function(a,e){(d.isUndefined(b)&&e||e===b)&&c.resolve.apply(this,arguments)}),c},save:function(){this.trigger("save");var a=this.promise=c.Model.prototype.save.apply(this,arguments);return a?a.then(function(){this.collection&&this.store(this.collection.modelName+":"+this.id),this.setFetched(!0),this.trigger("save:success")}.bind(this)).fail(function(a){this.trigger("save:failed",a)}.bind(this)):this.trigger("save:invalid"),a}});s.mixin=j;var t=b.Collection=c.Collection.extend({mediator:i,modelName:"base",initialize:function(a,b){b||(b={}),this.setFetched(!!b.fetched),this._resourceId=b.resourceId,this._nested=b.nested,this._resourceUrl=this.url,this.url=this._url,this.allowEmpty=this.allowEmpty,this.init.apply(this,arguments)},init:function(){},_url:function(){var a=d.result(this,"_resourceUrl"),b=0;if(!a)throw"url is required to fetch resource";return a=a.replace(h,function(a){return a=this._nested[b],b+=1,a}.bind(this))},_prepareModel:function(a,b){if(a instanceof c.Model)return a;b=b?d.clone(b):{},b.collection=this;var e=this.model(a,b);return e.validationError?(this.trigger("invalid",this,e.validationError,b),!1):e},model:function(a,b){var c=l(this.modelName,a,b);return c.id&&"base"!=this.modelName&&c.store(this.modelName+":"+c.id),d.keys(a).length>1&&c.setFetched(!0),c},move:function(a,b){var c=this.indexOf(a);if(-1==c)throw new Error("Can't move a model that's not in the collection");c!==b&&this.models.splice(b,0,this.models.splice(c,1)[0]),this.trigger("move",a,c,b)},isFetched:function(){return this._fetched},setFetched:function(a){this._fetched=a,a&&(this.promise=e.Deferred().resolve(this))},fetch:function(){return this.promise=c.Collection.prototype.fetch.apply(this,arguments).then(function(){(this.length||this.allowEmpty)&&this.setFetched(!0),this.trigger("fetched")}),this.trigger("fetch",this.promise),this.promise},fetchCached:function(a){return this.isFetched()?e.Deferred().resolve(this):this.promise&&"pending"===this.promise.state()?this.promise:this.fetch(a)}});t.mixin=j;var u=["bodyClass","el"],v=b.Controller=function(a){this.cid=d.uniqueId("controller"),this._configure(a||{}),this.views=[],this._actionResources={},d.each(this.resources,function(a,b){var c=a.actions;a.name=b,c&&"all"!==c[0]||(c=d.keys(this.actions)),d.each(c,function(b){var c;d.isArray(this._actionResources[b])||(this._actionResources[b]=[]),c=this._actionResources[b],c.push(a)},this)},this),this.$el=e(this.el?this.el:"<div/>"),this.initialize.apply(this,arguments)};d.extend(v.prototype,c.Events,{mediator:i,fetcher:r,modelManager:n,collectionManager:q,initialize:function(){},_configure:function(a){this.options&&(a=d.extend({},d.result(this,"options"),a)),d.extend(this,d.pick(a,u)),this.options=a},_action:function(a){var b,c=d.compact(Array.prototype.slice.call(arguments,1)),g=this.actions[a],h=[];if(!d.isFunction(g))throw"Controller does not support the "+a+" action!";if(e("html, body").scrollTop(0),this.setBodyClass(this.bodyClass),b=this._actionResources[a],d.isArray(b)&&b.length){var i,j,k,l={},m={},n=1;d.each(c,function(a){m["$"+n]=a,n+=1}),c.length&&(k=c[c.length-1]),d.each(b,function(a){j="",i=null,a.id&&(j=d.isFunction(a.id)?a.id.apply(this,c):f(a.id,/\$\d+/g,m)),a.params&&(i={},d.each(a.params,function(a,b){a=f(a,/\$\d+/g,m),i[b]=a}));var b=this.fetcher.fetch({id:j,data:a.model?{id:k}:null,model:a.model,collection:a.collection,options:{resourceId:j,nested:c},fetchOptions:{data:i}});a.wait&&h.push(b.promise),l[a.name]=b},this),e.when.apply(e,h).always(function(){g.call(this,l,c)}.bind(this))}else g.apply(this,c)},append:function(a){return d.isArray(a)||(a=[a]),d.each(a,function(a){this.views.push(a),this.$el.append(a.render().$el),a._onInsert()},this),this},setBodyClass:function(a){e("body").removeClass(this.bodyClass),e("body").removeClass(this.actionBodyClass),this.actionBodyClass=a,this.actionBodyClass&&e("body").addClass(this.actionBodyClass)},setPageTitle:function(a){e("title").text(a)},remove:function(){e("body").removeClass(this.bodyClass),e("body").removeClass(this.actionBodyClass),d.invoke(this.views,"remove"),this.$el.empty(),this.views=[]}}),v.extend=c.Model.extend,v.mixin=j;var w=["routes","controllerPath","middlewarePath"],x=function(a){this.cid=d.uniqueId("dispatcher"),this._configure(a||{}),this._router=new c.Router,this.buildRoutes(this.routes),this.initialize.apply(this,arguments)};d.extend(x.prototype,c.Events,{nestCount:0,controllerPath:"controllers/",middlewarePath:"middlewares/",mediator:i,initialize:function(){this.mediator.on("navigate",this._router.navigate,this),this.on("dispatched",function(){this.mediator.trigger("dispatched")},this)},_configure:function(a){this.options&&(a=d.extend({},d.result(this,"options"),a)),d.extend(this,d.pick(a,w)),this.options=a},loadMiddlewares:function(a){return d.map(a,function(a){return require(this.middlewarePath+a)},this)},buildRoutes:function(a,b,c){var e;b||(b=""),this.nestCount+=1,d.each(a,function(a,f){c||(c=[]),"middleware"===f?(d.isArray(a)||(a=[a]),c=c.concat(this.loadMiddlewares(a))):d.isObject(a)?(1===this.nestCount?b=f:b+=f,this.buildRoutes(a,b,c),this.nestCount-=1):(e=f,b&&(e=b+e),this._router.route(e,d.bind(this.dispatch,this,a,c)))},this)},dispatch:function(a,b){var c=Array.prototype.slice.call(arguments,2),e=a.split("#"),f=e[0],g=e[1],h=require(this.controllerPath+f),i="";if(b&&b.length&&d.each(b,function(a){a.apply(null,c)}),!h)throw f+" is not a defined controller";if(c.unshift(g),this._activeController&&this._activeController.remove(),this._activeController&&this._activeControllerName===f||(this._activeController=new h(c)),i=this._activeController.actions[g],!i)throw f+" controller has not implemented "+g;this._activeController._action.apply(this._activeController,c),this._activeControllerName=f,this.trigger("dispatched",f,g)}}),x.extend=c.Model.extend;var y=["template","skipDependencies"],z=b.View=c.View.extend({init:g,afterRender:g,onRemove:g,onError:g,showLoader:g,hideLoader:g,mediator:i,spinOptions:{color:"#444",preset:"small"},initialize:function(a){function b(a){a&&a.promise&&"pending"===a.promise.state()&&c.push(a.promise)}a||(a={}),this._rendered=!1,this._views=[],this._errors=[],this.resources=d.extend({},a.resources),d.extend(this,d.pick(a,y)),this.data=d.extend({},this.data),a.data&&this.set(a.data),this.mediatorEvents&&this._attachMediatorEvents(),this.resourceEvents&&this._attachResourceEventsGroup(this.resourceEvents),this.$el.on("remove",d.bind(this.remove,this));var c=[];this.skipDependencies||(d.each(this.resources,b),this.model&&b(this.model),this.collection&&b(this.collection),c.length&&this.whenFetching(c)),this.init(a)},render:function(){var a={},b={};return this.fetching?this:(this.template&&(d.each(this.resources,function(b,c){b&&(a[c]=b.models?d.pluck(b.models,"attributes"):b.attributes)}),this.model&&(a.model=this.model.attributes),d.each(d.result(this,"data"),function(a,c){b[c]=this.get(c)},this),d.extend(a,b),this.$el.html(this.template(a))),this._rendered=!0,this.afterRender(this.resources),this)},get:function(a){return a=this.data[a],d.isFunction(a)?a.call(this):a},set:function(a,b){void 0===b?d.merge(this.data,a):this.data[a]=b,this._rendered&&this.render()},prepend:function(a,b){return d.isString(b)&&(b=this.$(b)),this._attach("prepend",a,b),this},prependTo:function(a){return this.prepend(this,a),this},append:function(a,b){return d.isString(b)&&(b=this.$(b)),this._attach("append",a,b),this},appendTo:function(a){return this.append(this,a),this},after:function(a,b){return d.isString(a)&&(a=this.$(a)),this._attach("after",b,a),this},before:function(a,b){return d.isString(a)&&(a=this.$(a)),this._attach("before",b,a),this},empty:function(){return this._removeNested(),this.$el.html(""),this},reset:function(a){d.isUndefined(a)&&(a=[]);var b=this._renderViews(a);return this.$el.html(b),this._removeNested(),this._viewsInserted(a),this},replaceWith:function(a){this.$el.after(a.render().el),a.delegateEvents(),a._onInsert(),this.remove(),this.listenTo(a,"all",this.trigger)},remove:function(){return this.hasRemoved||(this.hasRemoved=!0,this._removeMediatorEvents(),this._removeNested(),c.View.prototype.remove.call(this),this.$el.off("remove"),this.onRemove()),this},getItemById:function(a){var b,c,d=a.attr("data-id");return b=this.collection.get(d?d:a.closest("[data-id]").attr("data-id")),b||(c=a.attr("data-cid"),b=this.collection.get(c?c:a.closest("[data-cid]").attr("data-cid"))),b},stopProp:function(a){return a&&a.stopPropagation&&(a.stopPropagation(),a.preventDefault()),this},stopPropagation:function(a){return a&&a.stopPropagation&&a.stopPropagation(),this},whenFetching:function(a){this.fetching||(!d.isArray(a)&&(a=[a]),this.fetching=!0,this.showLoader(a),e.when.apply(e,a).always(function(){this.fetching=!1,this.hideLoader()}.bind(this)).then(this.afterFetch.bind(this),this.onError.bind(this)))},afterFetch:function(){this.render()},_onInsert:function(){this.hasRemoved=!1,this.onInsert&&d.defer(this.onInsert.bind(this))},_renderViews:function(a){return d.map(a,function(a){return a.render().el},this)},_viewsInserted:function(a){d.each(a,function(a){a!=this&&this._views.push(a),a._onInsert.call(a)},this)},_removeNested:function(){d.invoke(this._views,"remove"),this._views=[]},_attach:function(a,b,c){c||(c=this.$el),d.isArray(b)||(b=[b]);var e=this._renderViews(b);c[a](e),this._viewsInserted(b)},_attachMediatorEvents:function(a){(a||(a=d.result(this,"mediatorEvents")))&&(this._removeMediatorEvents(),d.each(a,function(a,b){if(d.isFunction(a)||(a=this[a]),!a)throw new Error("Method "+a+" does not exist");this.mediator.on(b,a,this)},this))},_removeMediatorEvents:function(){this.mediator.off(null,null,this)},_attachResourceEventsGroup:function(a){var b,c,e=this.resources;d.each(a,function(a,d){if(c=d.split("."),("collection"==c[0]||"model"==c[0])&&(e=this),b=c.reduce(function(a,b){return a[b]},e),!b)throw new Error(d+" not found in view to attach events to");this._attachResourceEvents(a,b)},this)},_attachResourceEvents:function(a,b){d.each(a,function(a,c){d.each(a.split(" "),function(a){if(d.isFunction(a)||(a=this[a]),!a)throw new Error("Method "+a+" does not exist");this.listenTo(b,c,a)},this)},this)}});z.mixin=j;{var A=["modelView","infinite","$infiniteTarget"];b.CollectionView=z.extend({showEmpty:g,hideEmpty:g,collectionEvents:{reset:"render",add:"addOne hideEmpty",remove:"checkEmpty",fetch:"whenFetching"},initialize:function(a){z.prototype.initialize.apply(this,arguments),d.bindAll(this,"onScroll"),d.extend(this,d.pick(a,A)),this._setupInfinite(a),this._attachResourceEventsGroup({collection:this.collectionEvents})},render:function(){var a=this.template?this.template():"";return this.hideEmpty(),this.$el.html(a),this.fetching?this:(this.collection.length?this.collection.each(this.addOne,this):this.showEmpty(),this.afterRender(),this)},addOne:function(a){var b,c,d=this.collection.indexOf(a);return c=new this.modelView({model:a,resources:this.resources}),this.beforeEach&&c.$el.before(this.beforeEach(a)),b=this._viewElAt(d),b.length?this.before(b,c):this.append(c),this.afterEach&&c.$el.after(this.afterEach(a)),this._views.push(c),c},onScroll:function(){var a=this.$infiniteTarget.scrollTop()+this.$infiniteTarget.height(),b=this.$infiniteTarget.get(0).scrollHeight||e(document).height();if(a>=b-this.infniteOptions.offset&&!this.fetching&&this.prevScrollY<=a&&!this.infiniteEnd){var c=this.collection.length,f={remove:!1};if(!c&&this.collection.isFetched())return void(this.infiniteEnd=!0);this.infniteOptions.data&&(f.data=d.result(this.infniteOptions,"data")),this.collection.fetchNext(f).always(function(){this.collection.length===c&&(this.infiniteEnd=!0)}.bind(this))}this.prevScrollY=a},afterFetch:function(){this.checkEmpty()},checkEmpty:function(){0===this.collection.length?this.showEmpty():this.hideEmpty()},onRemove:function(){this.$infiniteTarget&&this.$infiniteTarget.off("scroll",this.onScroll)},_setupInfinite:function(){this.infinite&&(this.infniteOptions=d.extend({offset:300},this.infinite),this.$infiniteTarget=this.$infiniteTarget||this.$el,this.$infiniteTarget.on("scroll",this.onScroll))},_currentRenderedCount:function(){var a=this.modelView.prototype.className.split(" ")[0];return this.$("."+a).length},_viewElAt:function(a){var b=this.modelView.prototype.className.split(" ")[0];return this.$("."+b).eq(a)}}),b.ItemView=z.extend({modelEvents:{change:"render",invalid:"onInvalid",remove:"removeItem"},initialize:function(){this.model&&this._attachResourceEvents(this.modelEvents,this.model),z.prototype.initialize.apply(this,arguments),this.collection=this.model.collection},removeItem:function(a,b,c){!c.silent&&this.remove()},onInvalid:function(){}})}return b});